---
- name: 1. Gather facts and set host_info for remote hosts
  hosts: all
  gather_facts: yes

  tasks:
    # 1. Gather package facts
    - name: Gather package facts
      ansible.builtin.package_facts:
        manager: auto

    # 2. Set host details as a fact (this is done on the remote host)
    - name: Set host details as a fact
      ansible.builtin.set_fact:
        host_info:
          hostname: "{{ ansible_hostname }}"
          os_version: "{{ ansible_distribution }} {{ ansible_distribution_version }}"
          dnf_automatic_status: >-
            {% if 'dnf-automatic' in ansible_facts.packages %} Installed ✅ {% else %} Not Installed ❌ {% endif %}

- name: 2. Build and Display the Table on the Control Node
  hosts: localhost # Target only the control node for this final step
  gather_facts: no

  tasks:
    # 3. Use an Ansible loop to build the data structure for the table
    - name: Build the reporting list from hostvars
      ansible.builtin.set_fact:
        report_data: "{{ report_data | default([]) + [hostvars[inventory_hostname]['host_info']] }}"
      vars:
        inventory_hostname: "{{ item }}" # item will be the host name
      loop: "{{ groups['all'] }}"
      run_once: true # This loop runs once on localhost

    # 4. Display the table using the new report_data list
    - name: Display table on the control node
      ansible.builtin.debug:
        msg: |
          {% set table_header = '| Server | Operating System | DNF Automatic Status |' %}
          {% set table_separator = '| :--- | :--- | :--- |' %}
          {{ table_header }}
          {{ table_separator }}
          {% for host_details in report_data %}
          | {{ host_details.hostname }} | {{ host_details.os_version }} | {{ host_details.dnf_automatic_status }} |
          {% endfor %}